@model OrderDetailsModel

@using SmartStore.Core.Domain.Catalog;
@using SmartStore.Web.Models.Common;
@using SmartStore.Web.Models.Order;

@{
    Layout = "_Layout";
    Html.AddTitleParts(T("PageTitle.OrderDetails").Text);
}

<div class="page page-order-details">
    <div class="clearfix mb-3">
        <div class="page-title mb-3 float-sm-left">
            <h1 class="h2 mb-0">
				@T("Order.OrderDetails")
				<small class="text-muted"><small>@Model.OrderNumber</small></small>
			</h1>
        </div>

        <div class="print-buttons float-sm-right">
            <a href="@Url.Action("print", new { id = Model.Id, pdf = false })" target="print" class="btn btn-secondary btn-sm print-order-button" rel="nofollow">
                <i class="fa fa-print"></i>
                <span>@T("Order.Print")</span>
            </a>
            @if (Model.DisplayPdfInvoice)
            {
				<a href="@Url.Action("print", new { id = Model.Id, pdf = true })" class="btn btn-secondary btn-sm pdf-order-button" rel="nofollow">
					<i class="fa fa-file-pdf-o"></i>
					<span>@T("Order.GetPDFInvoice")</span>
				</a>
            }
        </div>
    </div>

    <div class="page-body">
        @{ Html.RenderWidget("orderdetails_page_top"); }

		<div class="row mb-3">
			<div class="col-6 col-sm-auto pb-3">
				<h5 class="text-muted">@T("Order.OrderDate")</h5>
				<div>@Model.CreatedOn.ToShortDateString()</div>
			</div>
			<div class="col-6 col-sm-auto pb-3">
				<h5 class="text-muted">@T("Order.Order#")</h5>
				<div>@Model.OrderNumber</div>
			</div>

			@if (Model.DisplayPurchaseOrderNumber)
			{
				<div class="col-6 col-sm-auto pb-3">
					<h5 class="text-muted">@T("Order.PurchaseOrderNumber")</h5>
					<div>@Model.PurchaseOrderNumber</div>
				</div>
			}

			<div class="col-6 col-sm-auto pb-3">
				<h5 class="text-muted">@T("Order.OrderStatus")</h5>
				<div>@Model.OrderStatus</div>
			</div>
			<div class="col-6 col-sm-auto pb-3">
				<h5 class="text-muted">@T("Order.OrderTotal")</h5>
				<div class="text-success">@Model.OrderTotal</div>
			</div>
		</div>

        @{ Html.RenderWidget("orderdetails_page_overview"); }
       
		<div class="card card-block order-details-box">
			<div class="row">
				<div class="col-md-8">
					<div class="row">
						<div class="col mb-4 mb-lg-0 billinginfo">
							<h5>@T("Order.BillingAddress")</h5>
							@RenderAddress(Model.BillingAddress)
						</div>

						@if (Model.IsShippable && Model.ShippingAddress != null)
						{
							<div class="col mb-4 mb-lg-0 shippinginfo">
								<h5>@T("Order.ShippingAddress")</h5>
								@RenderAddress(Model.ShippingAddress)
							</div>
						}
					</div>
				</div>

				@if (Model.PaymentMethod.HasValue() || Model.IsShippable || Model.VatNumber.HasValue())
				{
					<div class="col-md-4">
						<div class="row">
							<div class="col">
								@if (Model.IsShippable)
								{
									<h5>@T("Order.ShippingMethod")</h5>
									<p>@Model.ShippingMethod</p>
								}
								@if (Model.PaymentMethod.HasValue())
								{
									<h5>@T("Order.PaymentMethod")</h5>
									<p>@Model.PaymentMethod</p>

									if (Model.CanRePostProcessPayment)
									{
										using (Html.BeginForm())
										{
											<input type="submit" name="repost-payment" value="@T("Order.CompletePayment")" class="btn btn-primary btn-sm btn-block re-order-button btn-above" />
											<div class="small text-muted pt-2">@T("Order.CompletePayment.Hint")</div>
										}
									}
								}
								@if (Model.VatNumber.HasValue())
								{
									<h5>@T("Order.VATNumber")</h5>
									<p>@Model.VatNumber</p>
								}
							</div>
						</div>
					</div>
				}
			</div>

		</div>

        @{ Html.RenderWidget("orderdetails_page_beforeproducts"); }

        @if (Model.Items.Count > 0)
        {
            <div class="card mt-4">
                <div id="order-items" class="cart">
                    <div class="cart-head">
                        <div class="cart-row">
                            <div class="cart-col cart-col-main">
                                @T("Order.Product(s).Item")
                            </div>
                            <div class="cart-col cart-col-price">
                                @T("Order.Product(s).Price")
                            </div>
                            <div class="cart-col cart-col-qty">
                                @T("Order.Product(s).Quantity")
                            </div>
                            <div class="cart-col cart-col-price cart-col-subtotal">
                                @T("Order.Product(s).Total")
                            </div>
                        </div>
                    </div>
					<div class="cart-body">
						@foreach (var item in Model.Items)
						{
							if (item.ProductType == ProductType.BundledProduct)
							{
								@SimpleProduct(item)
								@BundleProducts(item)
							}
							else
							{
								@SimpleProduct(item)
							}
						}
					</div>
                </div>

                @if (!String.IsNullOrEmpty(Model.CheckoutAttributeInfo))
                {
                    <div class="checkout-attributes card card-block">
                        @Html.Raw(Model.CheckoutAttributeInfo)
                    </div>
                }

                <div class="actions clearfix">
                    <div class="pull-right">
                        @if (Model.IsReturnRequestAllowed)
                        {
                            <a class="btn btn-secondary return-items-button" href="@Url.Action("ReturnRequest", "ReturnRequest", new { id = Model.Id })" rel="nofollow">
                                <i class="fa fa-reply"></i>
                                @T("Order.ReturnItems")
                            </a>
                        }

                        @if (Model.IsReOrderAllowed)
                        {
                            <a class="btn btn-primary re-order-button" href="@Url.Action("ReOrder", new { id = Model.Id })" rel="nofollow">
                                <i class="fa fa-shopping-cart"></i>
                                @T("Order.Reorder")
                            </a>
                        }
                    </div>
                </div>

            </div>
        }

        @{ Html.RenderWidget("orderdetails_page_afterproducts"); }

        <div class="row">
            <div class="total-info col-md-4 offset-md-8 mt-3">
                <table class="cart-summary table">
                    <tbody>
                        <tr>
                            <td class="cart-total-left">
                                <strong>@T("Order.SubTotal"):</strong>
                            </td>
                            <td class="cart-total-right text-sm-right">
                                <span class="text-nowrap">
                                    @Model.OrderSubtotal
                                </span>
                            </td>
                        </tr>
                        @if (!string.IsNullOrEmpty(Model.OrderSubTotalDiscount))
                        {
                            <tr>
                                <td class="cart-total-left">
                                    <strong>
                                        @T("Order.SubTotalDiscount"):
                                    </strong>
                                </td>
                                <td class="cart-total-right text-sm-right">
                                    <span class="text-nowrap">
                                        @Model.OrderSubTotalDiscount
                                    </span>
                                </td>
                            </tr>
                        }
                        @if (Model.IsShippable)
                        {
                            <tr>
                                <td class="cart-total-left">
                                    <strong>
                                        @T("Order.Shipping"):
                                    </strong>
                                </td>
                                <td class="cart-total-right text-sm-right">
                                    <span class="text-nowrap">
                                        @Model.OrderShipping
                                    </span>
                                </td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Model.PaymentMethodAdditionalFee))
                        {
                            <tr>
                                <td class="cart-total-left">
                                    <strong>
                                        @T("Order.PaymentMethodAdditionalFee"):
                                    </strong>
                                </td>
                                <td class="cart-total-right text-sm-right">
                                    <span class="text-nowrap">
                                        @Model.PaymentMethodAdditionalFee
                                    </span>
                                </td>
                            </tr>
                        }
                        @if (Model.DisplayTaxRates && Model.TaxRates.Count > 0)
                        {
                            foreach (var taxRate in Model.TaxRates)
                            {
                                <tr>
                                    <td class="cart-total-left">
                                        <strong>
                                            @string.Format(T("Order.TaxRateLine").Text, taxRate.Rate):
                                        </strong>
                                    </td>
                                    <td class="cart-total-right text-sm-right">
                                        <span class="text-nowrap">
                                            @taxRate.Value
                                        </span>
                                    </td>
                                </tr>
                            }
                        }
                        @if (Model.DisplayTax)
                        {
                            <tr>
                                <td class="cart-total-left">
                                    <strong>
                                        @T("Order.Tax"):
                                    </strong>
                                </td>
                                <td class="cart-total-right text-sm-right">
                                    <span class="text-nowrap">
                                        @Model.Tax
                                    </span>
                                </td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Model.OrderTotalDiscount))
                        {
                            <tr>
                                <td class="cart-total-left">
                                    <strong>
                                        @T("Order.TotalDiscount"):
                                    </strong>
                                </td>
                                <td class="cart-total-right text-sm-right">
                                    <span class="text-nowrap">
                                        @Model.OrderTotalDiscount
                                    </span>
                                </td>
                            </tr>
                        }
                        @if (Model.GiftCards.Count > 0)
                        {
                            foreach (var gc in Model.GiftCards)
                            {
                                <tr>
                                    <td class="cart-total-left">
                                        <strong>@string.Format(T("Order.GiftCardInfo").Text, gc.CouponCode):</strong>
                                        <br />
                                        <span class="text-nowrap">@string.Format(T("ShoppingCart.Totals.GiftCardInfo.Remaining").Text, gc.Remaining)</span>
                                    </td>
                                    <td class="cart-total-right text-sm-right">
                                        <span class="text-nowrap">
                                            @gc.Amount
                                        </span>
                                    </td>
                                </tr>
                            }
                        }
                        @if (Model.RedeemedRewardPoints > 0)
                        {
                            <tr>
                                <td class="cart-total-left">
                                    <strong>@string.Format(T("Order.RewardPoints").Text, Model.RedeemedRewardPoints):</strong>
                                </td>
                                <td class="cart-total-right text-sm-right">
                                    <span class="text-nowrap">
                                        @Model.RedeemedRewardPointsAmount
                                    </span>
                                </td>
                            </tr>
                        }
                        <tr>
                            <td class="cart-total-left">
                                <strong>
                                    @T("Order.OrderTotal"):
                                </strong>
                            </td>
                            <td class="cart-total-right text-sm-right">
                                <span class="text-nowrap">
                                    <strong>
                                        @Model.OrderTotal
                                    </strong>
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        @{ Html.RenderWidget("orderdetails_page_aftertotal"); }

        @if (Model.Shipments.Count > 0)
        {
            <div class="section-title">
                @T("Order.Shipments")
            </div>

            <div class="shipments-box">
                <table class="table">
                    <thead>
                        <tr>
                            <th>
                                @T("Order.Shipments.ID")
                            </th>
                            <th>
                                @T("Order.Shipments.TrackingNumber")
                            </th>
                            <th>
                                @T("Order.Shipments.ShippedDate")
                            </th>
                            <th>
                                @T("Order.Shipments.DeliveryDate")
                            </th>
                            <th>
                                @T("Order.Shipments.ViewDetails")
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Shipments)
                        {
                            <tr>
                                <td>
                                    @item.Id.ToString()
                                </td>
                                <td>
                                    @item.TrackingNumber
                                </td>
                                <td>
                                    @if (item.ShippedDate.HasValue)
                                    {
                                        @item.ShippedDate.Value.ToString("D")
                                    }
                                    else
                                    {
                                        @T("Order.Shipments.ShippedDate.NotYet")
                                    }
                                </td>
                                <td>
                                    @if (item.DeliveryDate.HasValue)
                                    {
                                        @item.DeliveryDate.Value.ToString("D")
                                    }
                                    else
                                    {
                                        @T("Order.Shipments.DeliveryDate.NotYet")
                                    }
                                </td>
                                <td>
                                    <a href="@Url.Action("ShipmentDetails", new { id = item.Id })" title="@T("Order.Shipments.ViewDetails")">@T("Order.Shipments.ViewDetails")</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @if (Model.OrderNotes.Count > 0)
        {
            <div class="section-title">
                @T("Order.Notes")
            </div>

            <div class="ordernotes-box">
                <table class="table">
                    <thead>
                        <tr>
                            <th>
                                @T("Order.Notes.CreatedOn")
                            </th>
                            <th>
                                @T("Order.Notes.Note")
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.OrderNotes)
                        {
                            <tr>
                                <td>
                                    @item.CreatedOn.ToString()
                                </td>
                                <td>
                                    @Html.Raw(item.Note)
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @{ Html.RenderWidget("orderdetails_page_bottom"); }

    </div>
</div>


@helper RenderAddress(AddressModel address)
{
	var cityStateZip = address.GetFormattedCityStateZip();

	<div class="mb-2">
		@if (address.CompanyEnabled && address.Company.HasValue())
		{
			<div class="company">
				@Model.BillingAddress.Company
			</div>
		}
		<div class="name">
			@address.GetFormattedName()
		</div>
		@if (address.StreetAddressEnabled && address.Address1.HasValue())
		{
			<div class="address1">
				@address.Address1
			</div>
		}
		@if (address.StreetAddress2Enabled && address.Address2.HasValue())
		{
			<div class="address2">
				@address.Address2
			</div>
		}
		@if (cityStateZip.HasValue())
		{
			<div class="city-state-zip">
				@Html.Raw(cityStateZip)
			</div>
		}
		@if (address.CountryEnabled && address.CountryName.HasValue())
		{
			<div class="country">
				@address.CountryName
			</div>
		}
	</div>

	<div class="email">
		@T("Order.Email"): @address.Email
	</div>
	if (address.PhoneEnabled && address.PhoneNumber.HasValue())
	{
		<div class="phone">
			@T("Order.Phone"): @address.PhoneNumber
		</div>
	}
	if (address.FaxEnabled && address.FaxNumber.HasValue())
	{
		<div class="fax">
			@T("Order.Fax"): @address.FaxNumber
		</div>
	}
}

@helper SimpleProduct(OrderDetailsModel.OrderItemModel item)
{
	<div class="cart-row">
		<div class="cart-col cart-col-main">
			<div class="row sm-gutters">
				@if (Model.ShowProductImages && item.Picture != null && item.Picture.ImageUrl.HasValue())
				{
					<div class="col cart-item-img">
						<img class="img-fluid" alt="@item.Picture.AlternateText" src="@item.Picture.ImageUrl" title="@item.Picture.Title" />
					</div>
				}
				<div class="col">
					<a class="cart-item-link" href="@item.ProductUrl" title="@T("Products.Details")">@item.ProductName</a>
					@if (Model.ShowSku && item.Sku.HasValue())
					{
						<div class="cart-item-sku small">
							<span>@T("Order.Product(s).SKU")</span>
							<span class="text-muted">@item.Sku</span>
						</div>
					}
					@if (item.AttributeInfo.HasValue())
					{
						<div class="cart-item-attrs">
							@Html.Raw(item.AttributeInfo)
						</div>
					}
				</div>
			</div>
		</div>
		<div class="cart-col cart-col-price" data-caption="@T("Order.Product(s).Price")">
			<span class="price">@item.UnitPrice</span>
		</div>
		<div class="cart-col cart-col-qty" data-caption="@T("Order.Product(s).Quantity")">
			@item.Quantity
			@item.QuantityUnit
		</div>
		<div class="cart-col cart-col-price cart-col-subtotal" data-caption="@T("Order.Product(s).Total")">
			<span class="price">@item.SubTotal</span>
		</div>
	</div>
}

@helper BundleProducts(OrderDetailsModel.OrderItemModel parentItem)
{
	if (parentItem.BundleItems != null)
	{
		foreach (var item in parentItem.BundleItems.OrderBy(x => x.DisplayOrder))
		{
			<div class="cart-row cart-row-child">
				<div class="cart-col cart-col-main">
					<div class="row sm-gutters">
						<div class="col cart-item-img">
							<!-- Spacer -->
						</div>
						<div class="col">
							@if (item.Quantity > 1 && parentItem.BundlePerItemShoppingCart)
							{
								<span class="font-weight-medium">@item.Quantity&nbsp;&#215;</span>
							}
							@if (item.VisibleIndividually)
							{
								<a class="cart-item-link" href="@item.ProductUrl" title="@T("Products.Details")">@item.ProductName</a>
							}
							else
							{
								<span class="cart-item-link">@item.ProductName</span>
							}
							@if (item.AttributeInfo.HasValue())
							{
								<div class="cart-item-attrs">
									@Html.Raw(item.AttributeInfo)
								</div>
							}
						</div>
					</div>
				</div>
				<div class="cart-col cart-col-price">
					@if (item.PriceWithDiscount.HasValue())
					{			
						<span class="price">@Html.Raw(item.PriceWithDiscount)</span>
					}
					else
					{
						<text>&nbsp;</text>
					}
				</div>
				<div class="cart-col">&nbsp;</div>
				<div class="cart-col">&nbsp;</div>
			</div>
		}
	}
}