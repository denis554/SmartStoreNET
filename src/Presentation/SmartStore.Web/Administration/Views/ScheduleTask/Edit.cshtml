@model ScheduleTaskModel
@using SmartStore
@using SmartStore.Core
@{
	ViewBag.Title = "Aufgabe bearbeiten" + " - " + Model.Name;
	var cronHelpLink = WorkContext.WorkingLanguage.UniqueSeoCode.ToLower() == "de" ? "https://de.wikipedia.org/wiki/Cron" : "https://en.wikipedia.org/wiki/Cron";
	var returnUrl = ((string)ViewBag.ReturnUrl).NullEmpty();
}

@using (Html.BeginForm())
{
	@Html.AntiForgeryToken()
	@Html.HiddenFor(model => model.Id)
	@Html.Hidden("returnUrl", returnUrl)

	<div class="section-header">
		<div class="title">
			<i class="fa fa-clock-o"></i>
			@ViewBag.Title
			<a href='@(returnUrl ?? Url.Action("List"))'>(@T("Common.Back"))</a>
		</div>
		<div class="options">
			<button type="submit" name="save" value="save" class="btn btn-primary"><i class="fa fa-check"></i>&nbsp;@T("Admin.Common.Save")</button>
			<button type="submit" name="save" value="save-continue" class="btn">@T("Admin.Common.SaveContinue")</button>
			<a href="@Model.ExecuteUrl" class="btn"><i class='fa fa-play'></i>&nbsp;@T("Admin.System.ScheduleTasks.RunNow")</a>
		</div>
	</div>
	
	@Html.ValidationSummary(true)
	
	<table class="adminContent">
		<tr>
			<td class="adminTitle">
				@Html.SmartLabelFor(model => model.Name)
			</td>
			<td class="adminData">
				@Html.EditorFor(model => model.Name)
				@Html.ValidationMessageFor(model => model.Name)
			</td>
		</tr>
		<tr>
			<td class="adminTitle">
				@Html.SmartLabelFor(model => model.Enabled)
			</td>
			<td class="adminData">
				@Html.EditorFor(model => model.Enabled)
				@Html.ValidationMessageFor(model => model.Enabled)
			</td>
		</tr>
		<tr>
			<td class="adminTitle">
				@Html.SmartLabelFor(model => model.StopOnError)
			</td>
			<td class="adminData">
				@Html.EditorFor(model => model.StopOnError)
				@Html.ValidationMessageFor(model => model.StopOnError)
			</td>
		</tr>
		<tr>
			<td class="adminTitle">
				@Html.SmartLabelFor(model => model.LastStartPretty)
			</td>
			<td class="adminData">
				@Html.DisplayFor(model => model.LastStartPretty)
			</td>
		</tr>
		<tr>
			<td class="adminTitle">
				@Html.SmartLabelFor(model => model.NextRunPretty)
			</td>
			<td class="adminData">
				@Html.DisplayFor(model => model.NextRunPretty)
			</td>
		</tr>
		<tr>
			<td class="adminTitle">
				@Html.SmartLabelFor(model => model.Duration)
			</td>
			<td class="adminData">
				@Html.DisplayFor(model => model.Duration)
			</td>
		</tr>
		@if (Model.LastError.HasValue())
		{
			<tr>
				<td class="adminTitle">
					@Html.SmartLabelFor(model => model.LastError)
				</td>
				<td class="adminData">
					@Html.DisplayFor(model => model.LastError)
				</td>
			</tr>
			<tr>
				<td class="adminTitle">
					@Html.SmartLabelFor(model => model.LastSuccessPretty)
				</td>
				<td class="adminData">
					@Html.DisplayFor(model => model.LastSuccessPretty)
				</td>
			</tr>
		}
		<tr>
			<td class="adminTitle">
				@Html.SmartLabelFor(model => model.CronExpression)
			</td>
			<td class="adminData">
				@Html.EditorFor(model => model.CronExpression )
				@Html.ValidationMessageFor(model => model.CronExpression)
			</td>
		</tr>
		<tr>
			<td class="adminTitle">&nbsp;</td>
			<td class="adminData">
				<div class="muted">Hilfe zu <a href='@cronHelpLink' target="_blank">Cron-Ausdrücken</a></div>
			</td>
		</tr>
		<tr>
			<td class="adminTitle">&nbsp;</td>
			<td class="adminData">
				<div id="future-schedules"></div>
			</td>
		</tr>
	</table>
}

<script>
	$(function () {
		$('#@Html.FieldIdFor(m => m.CronExpression)').on('input propertychange paste', function (e) {
			getFutureSchedules.apply(this);
		});

		getFutureSchedules.apply($('#@Html.FieldIdFor(m => m.CronExpression)')[0]);

		function getFutureSchedules() {
			var input = $(this);

			if (!input.val().length)
				return;

			$.ajax({
				cache: false,
				type: 'POST',
				url: '@Url.Action("FutureSchedules")',
				data: { expression: input.val() },
				success: function (data) {
					$('#future-schedules').html(data);
				},
				error: function (xhr, ajaxOptions, thrownError) {

				}
			});
		}
	});
</script>
